name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.10'

jobs:
  # ========================================
  # Job 1: Linting et qualité du code
  # ========================================
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run Black (code formatting)
        run: black --check src api tests
        continue-on-error: true

      - name: Run isort (import sorting)
        run: isort --check-only src api tests
        continue-on-error: true

      - name: Run Flake8 (linting)
        run: flake8 src api tests
        continue-on-error: true

      - name: Run Pylint (static analysis)
        run: pylint src api --exit-zero

      - name: Run MyPy (type checking)
        run: mypy src api --ignore-missing-imports
        continue-on-error: true

  # ========================================
  # Job 2: Tests de sécurité
  # ========================================
  security:
    name: Security Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run Bandit (security linter)
        run: bandit -r src api -f json -o bandit-report.json
        continue-on-error: true

      - name: Run Safety (dependency vulnerabilities)
        run: safety check --json
        continue-on-error: true

      - name: Upload security reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: |
            bandit-report.json

  # ========================================
  # Job 3: Tests unitaires
  # ========================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run unit tests
        run: pytest tests/ -m "unit" --cov=src --cov=api --cov-report=xml --cov-report=html --junitxml=junit.xml
        continue-on-error: false

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            junit.xml
            htmlcov/
            coverage.xml

  # ========================================
  # Job 4: Tests d'intégration
  # ========================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run integration tests
        run: pytest tests/test_integration.py -v --cov=src --cov-report=xml
        continue-on-error: false

  # ========================================
  # Job 5: Tests de l'API
  # ========================================
  api-tests:
    name: API Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Create mock model for API tests
        run: |
          mkdir -p models
          python -c "
          import joblib
          from sklearn.pipeline import Pipeline
          from sklearn.preprocessing import StandardScaler
          from sklearn.ensemble import RandomForestClassifier
          import numpy as np

          # Créer un modèle factice
          model = Pipeline([
              ('scaler', StandardScaler()),
              ('classifier', RandomForestClassifier(n_estimators=10, random_state=42))
          ])

          # Créer des données factices pour l'entraînement
          X = np.random.rand(100, 5)
          y = np.random.randint(0, 2, 100)

          # Entraîner le modèle
          model.fit(X, y)

          # Sauvegarder
          joblib.dump(model, 'models/credit_scoring_model.pkl')
          "

      - name: Run API tests
        run: pytest tests/test_api.py -v --cov=api --cov-report=xml
        continue-on-error: false

  # ========================================
  # Job 6: Tests de performance
  # ========================================
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run performance tests
        run: pytest tests/test_model_performance.py -v --benchmark-only
        continue-on-error: true

  # ========================================
  # Job 7: Build et validation du modèle
  # ========================================
  build-model:
    name: Build and Validate Model
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run ML pipeline
        run: python src/pipeline.py
        continue-on-error: false

      - name: Validate model artifact
        run: |
          if [ ! -f "models/credit_scoring_model.pkl" ]; then
            echo "Model file not found!"
            exit 1
          fi
          echo "Model file exists and is valid"

      - name: Upload model artifact
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: models/credit_scoring_model.pkl
          retention-days: 30

  # ========================================
  # Job 8: Documentation
  # ========================================
  documentation:
    name: Build Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Check README exists
        run: |
          if [ ! -f "README.md" ]; then
            echo "README.md not found!"
            exit 1
          fi

  # ========================================
  # Job 9: Summary et rapport final
  # ========================================
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [code-quality, security, unit-tests, integration-tests, api-tests, build-model]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "All tests completed!"
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "API Tests: ${{ needs.api-tests.result }}"
          echo "Build Model: ${{ needs.build-model.result }}"
